<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GoBuy Nepal • Create Pay Link</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root{
  --purple:#7a1ea1; --purple-700:#5b1680; --accent:#d35400;
  --bg:#f6f7fb; --card:#ffffff; --line:#e6e7ef; --ink:#1f2033; --muted:#7e8190;
  --ok:#2ecc71; --warn:#ff8a1f; --bad:#e74c3c; --blue:#3aa0ff;
  --shadow:0 12px 24px rgba(27,31,35,0.06); --radius:14px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
@media (max-width:1024px){.app{grid-template-columns:72px 1fr}}

.sidebar{
  position:sticky; top:0; height:100vh; background:#fff; border-right:1px solid var(--line);
  display:flex; flex-direction:column; gap:10px; padding:14px 10px;
}
.brand{display:flex; align-items:center; gap:10px; padding:8px 8px 14px; text-decoration:none}
.brand img{width:36px;height:36px;object-fit:contain}
.brand .t{font-weight:900; color:var(--purple)}
@media (max-width:1024px){ .brand .t{display:none} }
.nav{display:grid; gap:6px; margin-top:8px}
.nav a{
  display:grid; grid-template-columns:28px 1fr auto; align-items:center; gap:12px;
  padding:10px; border-radius:10px; color:#3b3d4d; text-decoration:none;
}
.nav a i{font-size:16px; color:var(--purple)}
.nav a:hover{background:#faf8ff}
.nav a.active{background:#f2e9ff; color:var(--purple); font-weight:800}
@media (max-width:1024px){
  .nav a{grid-template-columns:28px; justify-items:center}
  .nav a span, .nav a small{display:none}
}
.sidebar .spacer{flex:1}
.logout{color:var(--bad)!important}
.logout i{color:var(--bad)!important}

/* Main */
.main{display:flex; flex-direction:column; min-width:0}
.topbar{
  position:sticky; top:0; z-index:3; background:#fff; border-bottom:1px solid var(--line);
  display:flex; align-items:center; gap:12px; padding:10px 14px;
}
.search{flex:1; display:flex; align-items:center; gap:8px; background:#f3f4f8; border:1px solid var(--line); border-radius:999px; padding:8px 12px}
.search input{border:none; outline:none; background:transparent; width:100%}
.k-actions{display:flex; gap:8px}
.k-actions .btn{border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer}
.avatar{width:36px;height:36px;border-radius:50%;background:#eee url('https://i.pravatar.cc/72?img=31') center/cover no-repeat;border:1px solid var(--line)}

.content{padding:16px; display:grid; gap:16px}
.h1{font-weight:900; color:#3c3270}

/* Panels */
.grid{display:grid; grid-template-columns:1.2fr 1.8fr; gap:16px}
@media (max-width:1000px){ .grid{grid-template-columns:1fr} }
.panel{background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); overflow:hidden}
.ph{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--line)}
.ph .t{font-weight:900}
.pb{padding:14px; display:grid; gap:12px}

/* Requests list */
.list{display:grid; gap:10px}
.item{
  display:grid; grid-template-columns:36px 1fr auto; gap:10px; align-items:center;
  border:1px solid var(--line); border-radius:12px; padding:8px 10px; background:#fff; cursor:pointer;
}
.item:hover{background:#faf8ff}
.item .l{width:36px;height:36px;border-radius:10px;background:#faf8ff;border:1px solid #e6def7; display:flex; align-items:center; justify-content:center; color:var(--purple)}
.item .m .t{font-weight:800}
.item .m .s{font-size:12px; color:#7e8190}
.badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; color:#fff; background:#7a1ea1}

/* Form */
.row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
@media (max-width:720px){ .row{grid-template-columns:1fr} }
.field{display:grid; gap:6px}
label{font-size:12px; color:#7e8190}
input[type="text"],input[type="number"],input[type="email"],input[type="tel"],textarea{
  border:1px solid var(--line); border-radius:10px; padding:10px; width:100%; background:#fff;
}
textarea{min-height:80px}
.total{
  display:flex; align-items:center; justify-content:space-between; padding:12px; border:1px dashed #e6def7; border-radius:12px; background:#faf8ff; font-weight:900;
}
.actions{display:flex; gap:8px; flex-wrap:wrap}
.btn{border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px 14px; cursor:pointer}
.btn.primary{background:#f2e9ff; border-color:#e6def7}
.btn.success{background:#2ecc71; color:#fff; border:none}
.copy{display:flex; gap:8px; align-items:center}
.copy input{flex:1}

.toast{
  position:fixed; right:16px; bottom:16px; background:#1f2033; color:#fff; padding:10px 12px;
  border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(8px); transition:.25s; z-index:9999;
}
.toast.show{opacity:1; transform:none}
</style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Admin navigation">
    <a class="brand" href="admin.html"><img src="assets/icons/gobuynepal-logo.png" alt="GoBuy Nepal"/><div class="t">GoBuy Admin</div></a>
    <nav class="nav">
      <a href="admin.html"><i class="fa-solid fa-gauge"></i><span>Dashboard</span></a>
      <a href="admin-orders.html"><i class="fa-solid fa-bag-shopping"></i><span>Orders</span></a>
      <a href="admin-chat.html"><i class="fa-solid fa-comments"></i><span>Chats</span></a>
      <a href="admin-open-cases.html"><i class="fa-regular fa-life-ring"></i><span>Cases</span></a>
      <a href="admin-customers.html"><i class="fa-regular fa-user"></i><span>Customers</span></a>
      <a href="admin-analytics.html"><i class="fa-solid fa-chart-line"></i><span>Analytics</span></a>
      <a class="active" href="admin-paylink.html"><i class="fa-solid fa-link"></i><span>Pay link</span></a>
      <a href="admin-settings.html"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
    </nav>
    <div class="spacer"></div>
    <a class="nav logout" href="index.html"><i class="fa-solid fa-right-from-bracket"></i><span>Sign out</span></a>
  </aside>

  <!-- Main -->
  <section class="main">
    <header class="topbar">
      <div class="search"><i class="fa-solid fa-magnifying-glass"></i><input id="q" type="search" placeholder="Search requests…"></div>
      <div class="k-actions">
        <button class="btn" onclick="location.href='admin.html'"><i class="fa-solid fa-arrow-left"></i> Back</button>
      </div>
      <div class="avatar"></div>
    </header>

    <div class="content">
      <div class="h1">Create Pay Link</div>

      <section class="grid">
        <!-- Requests -->
        <div class="panel">
          <div class="ph"><div class="t">Incoming Customer Requests</div></div>
          <div class="pb">
            <div id="reqList" class="list"><!-- JS --></div>
          </div>
        </div>

        <!-- Builder -->
        <div class="panel">
          <div class="ph"><div class="t">Build Payable Order</div></div>
          <div class="pb">
            <div class="row">
              <div class="field"><label>Customer name</label><input id="cName" type="text" placeholder="Full name"></div>
              <div class="field"><label>Phone</label><input id="cPhone" type="tel" placeholder="+977-98xxxxxxx"></div>
            </div>
            <div class="row">
              <div class="field"><label>Email</label><input id="cEmail" type="email" placeholder="name@email.com"></div>
              <div class="field"><label>Reference / Notes</label><input id="cNotes" type="text" placeholder="e.g. Request form #R-2311"></div>
            </div>

            <div class="field"><label>Items / description</label><textarea id="cItems" placeholder="Write the items or paste from request…"></textarea></div>

            <div class="row">
              <div class="field"><label>Subtotal (NPR)</label><input id="subtotal" type="number" min="0" step="0.01" value="0"></div>
              <div class="field"><label>Shipping (NPR)</label><input id="shipping" type="number" min="0" step="0.01" value="0"></div>
            </div>
            <div class="row">
              <div class="field"><label>Tax (NPR)</label><input id="tax" type="number" min="0" step="0.01" value="0"></div>
              <div class="field"><label>Discount (NPR)</label><input id="discount" type="number" min="0" step="0.01" value="0"></div>
            </div>

            <div class="total">Total <span id="grand">NPR 0.00</span></div>

            <div class="actions">
              <button class="btn primary" id="genId"><i class="fa-solid fa-hashtag"></i> Generate Order ID</button>
              <button class="btn success" id="create"><i class="fa-solid fa-link"></i> Create Pay Link</button>
            </div>

            <div class="copy" id="linkWrap" style="display:none">
              <input id="payLink" type="text" readonly>
              <button class="btn" id="copyLink"><i class="fa-regular fa-copy"></i> Copy</button>
              <a id="openLink" class="btn" target="_blank"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open</a>
            </div>

            <div class="help">After you copy/share the link, the customer will see this order on their **Confirm Order** page with a <strong>Pay Now</strong> button.</div>
          </div>
        </div>
      </section>
    </div>
  </section>
</div>

<div id="toast" class="toast">Saved</div>

<script>
/* ---------- Demo customer requests (replace with API/Firestore) ---------- */
const REQUESTS = JSON.parse(localStorage.getItem('CUSTOMER_REQUESTS')||'null') || [
  {id:'R-2311', name:'Kriti S', phone:'+977-9801xxxxxx', email:'kriti@example.com', msg:'2x Black Hoodie (M), 1x Cargo Pants (30), budget ~ 2200'},
  {id:'R-2312', name:'Roshan P', phone:'+977-9812xxxxxx', email:'roshan@example.com', msg:'Wireless mouse + keyboard set, ship to Pokhara'},
  {id:'R-2313', name:'Mira L',  phone:'+977-9823xxxxxx', email:'mira@example.com',  msg:'Cosmetics mix: serum + sunscreen SPF50'}
];

const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const nf = (n)=>'NPR ' + Number(n||0).toFixed(2);

/* ---------- Render requests ---------- */
(function renderReq(){
  const box = $('#reqList'); box.innerHTML='';
  REQUESTS.forEach(r=>{
    const div = document.createElement('div');
    div.className='item'; div.tabIndex=0;
    div.innerHTML = `
      <div class="l"><i class="fa-regular fa-user"></i></div>
      <div class="m">
        <div class="t">${r.name} <span class="badge" style="margin-left:6px">${r.id}</span></div>
        <div class="s">${r.msg}</div>
      </div>
      <div>${r.phone}</div>`;
    div.addEventListener('click', ()=>fillFromRequest(r));
    div.addEventListener('keydown', (e)=>{ if(e.key==='Enter') fillFromRequest(r); });
    box.appendChild(div);
  });
})();

function fillFromRequest(r){
  $('#cName').value=r.name; $('#cPhone').value=r.phone; $('#cEmail').value=r.email;
  $('#cItems').value=r.msg; $('#cNotes').value=r.id;
  toast('Loaded request ' + r.id);
}

/* ---------- Totals ---------- */
['#subtotal','#shipping','#tax','#discount'].forEach(sel=>{
  $(sel).addEventListener('input', updateTotal);
});
function updateTotal(){
  const sub=+$('#subtotal').value||0, ship=+$('#shipping').value||0, tax=+$('#tax').value||0, disc=+$('#discount').value||0;
  const total = Math.max(0, sub+ship+tax-disc);
  $('#grand').textContent = nf(total);
  return total;
}
updateTotal();

/* ---------- Order ID & Pay link ---------- */
let currentOrderId = null;
$('#genId').addEventListener('click', ()=>{ currentOrderId = genId(); toast('Order ID: #' + currentOrderId); });

$('#create').addEventListener('click', ()=>{
  if(!currentOrderId) currentOrderId = genId();
  const name = $('#cName').value.trim() || 'Customer';
  const email = $('#cEmail').value.trim();
  const phone = $('#cPhone').value.trim();
  const notes = $('#cNotes').value.trim();
  const items = $('#cItems').value.trim();

  const sub=+$('#subtotal').value||0, ship=+$('#shipping').value||0, tax=+$('#tax').value||0, disc=+$('#discount').value||0;
  const total = updateTotal();

  // Save into admin orders (so it shows in dashboard)
  const storeKey = 'ADMIN_ORDERS';
  const orders = JSON.parse(localStorage.getItem(storeKey)||'[]');
  orders.unshift({
    id: currentOrderId,
    customer:{name, email, phone},
    status:'Awaiting Payment',
    charges:{subtotal:sub, shipping:ship, tax, discount:disc, total},
    notes, items,
    created: new Date().toISOString()
  });
  localStorage.setItem(storeKey, JSON.stringify(orders));

  // Build a customer link to Confirm Order page
  const link = `confirm-order.html?order=${encodeURIComponent(currentOrderId)}&name=${encodeURIComponent(name)}&total=${encodeURIComponent(total.toFixed(2))}`;
  $('#payLink').value = link;
  $('#openLink').href = link;
  $('#linkWrap').style.display='flex';
  toast('Pay link created');
});

$('#copyLink').addEventListener('click', ()=>{
  $('#payLink').select(); document.execCommand('copy');
  toast('Link copied');
});

function genId(){
  // timestamp-based readable order id (8xxx…9xxx)
  const base = 8000 + Math.floor((Date.now()/1000)%999);
  return String(base);
}

/* ---------- Toast ---------- */
function toast(msg){
  const t = $('#toast'); t.textContent = msg; t.classList.add('show');
  clearTimeout(window.__toast); window.__toast = setTimeout(()=>t.classList.remove('show'), 1400);
}
</script>
</body>
</html>
