<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GoBuy Nepal • Orders</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root{
  --purple:#7a1ea1; --purple-700:#5b1680; --accent:#d35400;
  --bg:#f6f7fb; --card:#ffffff; --line:#e6e7ef; --ink:#1f2033; --muted:#7e8190;
  --ok:#2ecc71; --warn:#ff8a1f; --bad:#e74c3c; --blue:#3aa0ff;
  --shadow:0 12px 24px rgba(27,31,35,.06); --radius:14px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

/* Layout */
.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
@media (max-width:1024px){.app{grid-template-columns:72px 1fr}}
.sidebar{
  position:sticky; top:0; height:100vh; background:#fff; border-right:1px solid var(--line);
  display:flex; flex-direction:column; gap:10px; padding:14px 10px;
}
.brand{display:flex; align-items:center; gap:10px; padding:8px 8px 14px}
.brand img{width:36px;height:36px;object-fit:contain}
.brand .t{font-weight:900; letter-spacing:.2px; color:var(--purple)}
@media (max-width:1024px){ .brand .t{display:none} }

.nav{display:grid; gap:6px; margin-top:8px}
.nav a{
  display:grid; grid-template-columns:28px 1fr auto; align-items:center; gap:12px;
  padding:10px; border-radius:10px; color:#3b3d4d; text-decoration:none;
}
.nav a i{font-size:16px; color:var(--purple)}
.nav a:hover{background:#faf8ff}
.nav a.active{background:#f2e9ff; color:var(--purple); font-weight:800}
@media (max-width:1024px){
  .nav a{grid-template-columns:28px; justify-items:center}
  .nav a span, .nav a small{display:none}
}
.sidebar .spacer{flex:1}
.logout{color:var(--bad)!important}
.logout i{color:var(--bad)!important}

/* Main */
.main{display:flex; flex-direction:column; min-width:0}
.topbar{
  position:sticky; top:0; z-index:3; background:#fff; border-bottom:1px solid var(--line);
  display:flex; align-items:center; gap:12px; padding:10px 14px;
}
.breadcrumb{font-weight:900; color:#3c3270}
.searchbar{
  margin-left:auto; display:flex; gap:8px; align-items:center;
}
.searchbar input, .searchbar select{
  border:1px solid var(--line); background:#fff; padding:8px 10px; border-radius:10px;
}
.content{padding:16px; display:grid; gap:16px}

/* Orders card */
.card{
  background:#fff; border:1px solid var(--line); border-radius:var(--radius);
  box-shadow:var(--shadow); overflow:hidden;
}
.card .ch{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:12px 14px; border-bottom:1px solid var(--line); font-weight:900;
}
.result-count{color:var(--muted); font-weight:600; font-size:13px}

/* Table */
.table{width:100%; border-collapse:collapse}
.table th,.table td{padding:12px 10px; border-bottom:1px solid var(--line); text-align:left; white-space:nowrap}
.table th{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px}
.table a.link{color:#2a63e5; text-decoration:none}
.table a.link:hover{text-decoration:underline}

.badge{display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800; color:#fff}
.b-await{background:var(--warn)}
.b-paid{background:var(--ok)}
.b-ship{background:var(--blue)}
.b-cancel{background:#b83b3b}

.actions{display:flex; gap:8px}
.btn{
  border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer;
  display:inline-flex; align-items:center; gap:6px;
}
.btn.view{border-color:#e7d8ff; color:var(--purple)}
.btn.pay{border-color:#ffd9b5; color:#ff8a1f}
.btn.cancel{border-color:#ffd0d0; color:#e74c3c}
.btn:hover{background:#fafafa}

/* Drawer (quick view) */
.backdrop{position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:50}
.drawer{
  position:fixed; top:0; right:0; height:100vh; width:420px; max-width:96vw; background:#fff;
  border-left:1px solid var(--line); box-shadow: -8px 0 24px rgba(0,0,0,.1);
  transform:translateX(100%); transition:.25s ease; z-index:51; display:flex; flex-direction:column;
}
.drawer.show{ transform:none }
.backdrop.show{ display:block }
.dw-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line); font-weight:900}
.dw-body{padding:14px; display:grid; gap:10px}
.kv{display:grid; grid-template-columns:120px 1fr; gap:8px}
.kv div:first-child{color:var(--muted); font-size:13px}
</style>
</head>
<body>

<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <img src="assets/icons/gobuynepal-logo.png" alt="GoBuy Nepal"/>
      <div class="t">GoBuy Admin</div>
    </div>
    <nav class="nav">
      <a href="admin.html"><i class="fa-solid fa-gauge"></i><span>Dashboard</span></a>
      <a class="active" href="admin-orders.html"><i class="fa-solid fa-bag-shopping"></i><span>Orders</span></a>
      <a href="admin-chat.html"><i class="fa-solid fa-comments"></i><span>Chats</span></a>
      <a href="admin-cases.html"><i class="fa-regular fa-circle-question"></i><span>Cases</span></a>
      <a href="admin-customers.html"><i class="fa-regular fa-user"></i><span>Customers</span></a>
      <a href="admin-analytics.html"><i class="fa-solid fa-chart-line"></i><span>Analytics</span></a>
      <a href="admin-settings.html"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
    </nav>
    <div class="spacer"></div>
    <a class="nav logout" href="index.html"><i class="fa-solid fa-right-from-bracket"></i><span>Sign out</span></a>
  </aside>

  <!-- Main -->
  <section class="main">

    <!-- Top bar -->
    <header class="topbar">
      <div class="breadcrumb">Orders</div>
      <div class="searchbar">
        <input id="q" type="search" placeholder="Search by ID or customer…"/>
        <select id="statusFilter">
          <option value="">All statuses</option>
          <option>Awaiting Payment</option>
          <option>Paid</option>
          <option>Shipped</option>
          <option>Cancelled</option>
        </select>
      </div>
    </header>

    <!-- Content -->
    <div class="content">
      <section class="card">
        <div class="ch">
          <div>Orders</div>
          <div class="result-count" id="resultCount">0 results</div>
        </div>

        <div class="cb">
          <table class="table" id="ordersTable">
            <thead>
              <tr>
                <th>Order</th>
                <th>Customer</th>
                <th>Status</th>
                <th>Total</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody><!-- rows via JS --></tbody>
          </table>
        </div>
      </section>
    </div>
  </section>
</div>

<!-- Quick View Drawer -->
<div id="backdrop" class="backdrop"></div>
<aside id="drawer" class="drawer" aria-modal="true" aria-hidden="true" role="dialog">
  <div class="dw-head">
    <div id="dwTitle">Order</div>
    <button id="dwClose" class="btn"><i class="fa-solid fa-xmark"></i> Close</button>
  </div>
  <div class="dw-body" id="dwBody"></div>
</aside>

<script>
/* ---------------- Seed orders (matches your screenshot) ---------------- */
const SEED = [
  {id:8101, customer:'Kriti S', status:'Awaiting Payment', total:220.50, created:stamp(-60*60*1000*0.0)}, // now-ish
  {id:8102, customer:'Roshan P', status:'Paid', total:99.00, created:stamp(-60*60*1000*1)},
  {id:8103, customer:'Mira L', status:'Shipped', total:340.10, created:stamp(-60*60*1000*3)},
  {id:8104, customer:'Rabin T', status:'Awaiting Payment', total:59.99, created:stamp(-60*60*1000*5)},
  {id:8105, customer:'Anu R', status:'Paid', total:190.00, created:stamp(-60*60*1000*7)}
];
// helper to make ISO strings
function stamp(offsetMs){ return new Date(Date.now()+offsetMs).toISOString(); }

/* Merge with locally created admin orders (from admin-new-order.html) */
function getOrders(){
  const local = JSON.parse(localStorage.getItem('ADMIN_ORDERS')||'[]').map(o => ({
    id: Number(o.id)||Date.now(), customer: o.customer?.name || 'Customer',
    status: o.status || o.payment?.status || 'Awaiting Payment',
    total: Number(o.charges?.total||0),
    created: o.created || new Date().toISOString()
  }));
  // latest first
  return [...local, ...SEED].sort((a,b)=> new Date(b.created) - new Date(a.created));
}

const $ = (sel,ctx=document)=>ctx.querySelector(sel);
const $$ = (sel,ctx=document)=>[...ctx.querySelectorAll(sel)];
const tbody = $('#ordersTable tbody');
const q = $('#q');
const statusFilter = $('#statusFilter');
const resultCount = $('#resultCount');

function fmtMoney(n){ return `NPR ${Number(n).toFixed(2)}`; }
function fmtDate(iso){ const d = new Date(iso); return d.toLocaleString(); }
function pill(status){
  const map = {
    'Awaiting Payment':'b-await',
    'Paid':'b-paid',
    'Shipped':'b-ship',
    'Cancelled':'b-cancel'
  };
  return `<span class="badge ${map[status]||'b-await'}">${status}</span>`;
}

let ORDERS = getOrders();

function render(){
  const term = q.value.trim().toLowerCase();
  const filt = statusFilter.value;
  const rows = ORDERS.filter(o => (!filt || o.status===filt) &&
                                  ( !term || String(o.id).includes(term) || o.customer.toLowerCase().includes(term) ));
  tbody.innerHTML = '';
  rows.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a class="link" href="#${o.id}" data-view="${o.id}">#${o.id}</a></td>
      <td>${o.customer}</td>
      <td>${pill(o.status)}</td>
      <td>${fmtMoney(o.total)}</td>
      <td>${fmtDate(o.created)}</td>
      <td class="actions">
        <button class="btn view" data-view="${o.id}"><i class="fa-regular fa-eye"></i> View</button>
        ${o.status==='Awaiting Payment' ? `<button class="btn pay" data-paid="${o.id}"><i class="fa-solid fa-receipt"></i> Mark paid</button>`:''}
        ${o.status!=='Cancelled' ? `<button class="btn cancel" data-cancel="${o.id}"><i class="fa-regular fa-circle-xmark"></i></button>`:''}
      </td>`;
    tbody.appendChild(tr);
  });
  resultCount.textContent = `${rows.length} result${rows.length!==1?'s':''}`;
}
render();

/* --- Actions --- */
tbody.addEventListener('click', (e)=>{
  const v = e.target.closest('[data-view]'); if(v){ openDrawer(Number(v.dataset.view)); return; }
  const p = e.target.closest('[data-paid]'); if(p){ markPaid(Number(p.dataset.paid)); return; }
  const c = e.target.closest('[data-cancel]'); if(c){ cancelOrder(Number(c.dataset.cancel)); return; }
});
q.addEventListener('input', render);
statusFilter.addEventListener('change', render);

/* --- Mark paid / Cancel update (affects localStorage orders if present) --- */
function updateLocal(id, mutator){
  const local = JSON.parse(localStorage.getItem('ADMIN_ORDERS')||'[]');
  const idx = local.findIndex(o => Number(o.id)===Number(id));
  if(idx>-1){ mutator(local[idx]); localStorage.setItem('ADMIN_ORDERS', JSON.stringify(local)); }
}
function markPaid(id){
  const o = ORDERS.find(x=>x.id===id); if(!o) return;
  o.status = 'Paid';
  updateLocal(id, x => { x.status='Paid'; x.payment = x.payment||{}; x.payment.status='Paid'; });
  render();
}
function cancelOrder(id){
  if(!confirm(`Cancel Order #${id}?`)) return;
  const o = ORDERS.find(x=>x.id===id); if(!o) return;
  o.status = 'Cancelled';
  updateLocal(id, x => { x.status='Cancelled'; });
  render();
}

/* --- Drawer quick view (and ?order=ID support) --- */
const drawer = $('#drawer'), backdrop = $('#backdrop'), dwTitle = $('#dwTitle'), dwBody = $('#dwBody');
$('#dwClose').addEventListener('click', closeDrawer);
backdrop.addEventListener('click', closeDrawer);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

function openDrawer(id){
  const o = ORDERS.find(x=>x.id===id); if(!o) return;
  dwTitle.textContent = `Order #${o.id}`;
  dwBody.innerHTML = `
    <div class="kv"><div>Status</div><div>${pill(o.status)}</div></div>
    <div class="kv"><div>Customer</div><div>${o.customer}</div></div>
    <div class="kv"><div>Total</div><div>${fmtMoney(o.total)}</div></div>
    <div class="kv"><div>Created</div><div>${fmtDate(o.created)}</div></div>
    <div class="kv"><div>Actions</div>
      <div class="actions">
        <a class="btn view" href="admin-order-builder.html?order=${encodeURIComponent(o.id)}"><i class="fa-regular fa-eye"></i> Open details</a>
        ${o.status==='Awaiting Payment' ? `<button class="btn pay" onclick="markPaid(${o.id})"><i class="fa-solid fa-receipt"></i> Mark paid</button>`:''}
        ${o.status!=='Cancelled' ? `<button class="btn cancel" onclick="cancelOrder(${o.id})"><i class="fa-regular fa-circle-xmark"></i> Cancel</button>`:''}
      </div>
    </div>
  `;
  drawer.classList.add('show'); backdrop.classList.add('show');
  drawer.setAttribute('aria-hidden','false');
}
function closeDrawer(){
  drawer.classList.remove('show'); backdrop.classList.remove('show');
  drawer.setAttribute('aria-hidden','true');
}

/* Open drawer automatically if ?order=ID is present */
const params = new URLSearchParams(location.search);
if(params.has('order')){ const id = Number(params.get('order')); if(id) openDrawer(id); }
</script>
</body>
</html>
