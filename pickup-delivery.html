<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pickup & Delivery Options • GoBuy Nepal</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --purple:#7a1ea1; --purple-700:#5b1680;
      --bg:#fff; --card:#fff; --line:#e9e9ef; --muted:#7b7f88;
      --green:#2ecc71; --danger:#e74c3c; --orange:#d35400;
      --radius:14px; --shadow:0 10px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:#1e1e1e;padding-bottom:96px}
    .page{max-width:450px;margin:0 auto;padding-bottom:140px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:3;background:#fff;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;padding:12px 14px 10px}
    .top-btn{color:var(--purple);font-size:18px;text-decoration:none}
    .title{font-weight:900;color:#444}
    .right{width:28px}

    .section{margin:16px 12px 10px;font-size:12px;text-transform:uppercase;color:var(--muted);letter-spacing:.4px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);margin:0 12px 14px;padding:12px}

    /* Fulfillment pills */
    .pill{background:#f5f5fb;border:1px solid var(--line);border-radius:999px;display:flex;gap:6px;padding:4px}
    .pill button{border:none;background:transparent;padding:8px 14px;border-radius:999px;font-weight:900;color:#666;cursor:pointer;flex:1}
    .pill button.active{background:#fff;color:var(--purple);border:1px solid #d9c9ee;box-shadow:var(--shadow)}

    /* Address list */
    .addr{border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0;background:#fff;display:grid;gap:6px}
    .addr-top{display:flex;align-items:center;gap:8px}
    .addr-name{font-weight:900}
    .addr-sub{font-size:12px;color:#666}
    .addr-actions{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .pill-mini{background:#f5f5fb;border:1px solid #e5def3;border-radius:999px;padding:3px 8px;font-size:11px;color:#6b5ea3;font-weight:800}
    .btn-mini{border:none;border-radius:8px;padding:8px 10px;font-weight:800;cursor:pointer}
    .btn-danger{background:#fff;color:var(--danger);border:2px solid var(--danger)}
    .btn-edit{background:#fff;color:#444;border:2px solid #ddd}

    /* Forms */
    .row{display:grid;gap:6px;margin-bottom:10px}
    label{font-weight:700;font-size:13px;color:#333}
    input[type="text"],input[type="tel"],input[type="date"],select,textarea{
      width:100%;padding:11px 12px;border:1px solid #dcdde3;border-radius:10px;outline:none;font-size:15px;background:#fff
    }
    textarea{min-height:92px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .btn{border:none;border-radius:12px;padding:13px 14px;font-weight:900;cursor:pointer}
    .btn-primary{background:var(--purple);color:#fff}
    .btn-outline{background:#fff;color:var(--purple);border:2px solid var(--purple)}
    .hint{font-size:12px;color:#777}

    /* Map placeholder */
    .map{height:160px;border:1px dashed #d9c9ee;border-radius:12px;background:#faf8ff;display:flex;align-items:center;justify-content:center;color:#6b5ea3;font-weight:800}

    /* Actions */
    .actions{position:fixed;left:0;right:0;bottom:70px;display:flex;justify-content:center;pointer-events:none;z-index:50}
    .actions .wrap{width:100%;max-width:450px;padding:0 12px;display:flex;gap:10px;pointer-events:auto}
    .btn-wide{flex:1}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:120px;transform:translateX(-50%);background:#222;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;opacity:0;transition:.25s;z-index:9999}
    .toast.show{opacity:1}

    /* Bottom nav */
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);
      display:flex;justify-content:space-around;align-items:center;padding:8px 0;z-index:999;box-shadow:0 -2px 8px rgba(0,0,0,.05)}
    .nav-item{color:var(--purple);text-decoration:none;font-size:12px;display:flex;flex-direction:column;align-items:center}
    .nav-item i{font-size:20px;margin-bottom:4px}
    .nav-item.active span{font-weight:800}
  </style>
</head>
<body>

<main class="page">
  <!-- Top bar -->
  <div class="topbar">
    <a class="top-btn" href="profile.html" aria-label="Back to Profile"><i class="fa-solid fa-chevron-left"></i></a>
    <div class="title">Pickup & Delivery Options</div>
    <div class="right"></div>
  </div>

  <!-- Fulfillment toggle -->
  <div class="section">Preferred method</div>
  <div class="card">
    <div class="pill" role="tablist" aria-label="Fulfillment">
      <button id="tabDelivery" class="active" role="tab" aria-selected="true"><i class="fa-solid fa-truck-fast"></i> Delivery</button>
      <button id="tabPickup" role="tab" aria-selected="false"><i class="fa-solid fa-store"></i> Pickup</button>
    </div>
    <div class="hint" style="margin-top:8px">Switch between delivery to your address or pickup from a nearby branch.</div>
  </div>

  <!-- DELIVERY SECTION -->
  <div id="deliverySection">
    <div class="section">Saved addresses</div>
    <div class="card">
      <div id="addrList">
        <div id="addrEmpty" class="hint">No saved addresses yet. Add one below.</div>
      </div>
    </div>

    <div class="section">Add / Edit address</div>
    <div class="card">
      <input type="hidden" id="editId">
      <div class="row">
        <label for="aName">Name</label>
        <input id="aName" type="text" placeholder="e.g., Home / Office">
      </div>
      <div class="row">
        <label for="aPhone">Phone</label>
        <input id="aPhone" type="tel" placeholder="98XXXXXXXX">
      </div>
      <div class="row">
        <label for="aStreet">Street Address</label>
        <input id="aStreet" type="text" placeholder="House / Street / Area">
      </div>
      <div class="grid-2">
        <div class="row">
          <label for="aCity">City</label>
          <input id="aCity" type="text" placeholder="e.g., Kathmandu">
        </div>
        <div class="row">
          <label for="aPostal">Postal Code</label>
          <input id="aPostal" type="text" placeholder="e.g., 44600">
        </div>
      </div>
      <div class="row">
        <label for="aCountry">Country</label>
        <input id="aCountry" type="text" placeholder="Nepal" value="Nepal">
      </div>
      <div class="row">
        <label><input type="checkbox" id="aDefault"> Set as default</label>
      </div>
      <div class="grid-2">
        <button class="btn btn-outline" id="btnClearAddr">Clear</button>
        <button class="btn btn-primary" id="btnSaveAddr">Save Address</button>
      </div>
      <div class="hint" style="margin-top:6px">Tip: Use clear names like “Home” or “Office”.</div>
    </div>

    <div class="section">Delivery preferences</div>
    <div class="card">
      <div class="row">
        <label>Method</label>
        <select id="dMethod">
          <option value="standard">Standard (3–5 days)</option>
          <option value="express">Express (1–2 days)</option>
        </select>
      </div>
      <div class="row">
        <label for="dInstr">Delivery instructions (optional)</label>
        <textarea id="dInstr" placeholder="e.g., Call on arrival, leave with guard"></textarea>
      </div>
      <div class="row">
        <div class="hint"><strong>Estimate:</strong> <span id="dEstimate">NPR 0 • ETA —</span></div>
      </div>
    </div>
  </div>

  <!-- PICKUP SECTION -->
  <div id="pickupSection" style="display:none">
    <div class="section">Select branch</div>
    <div class="card">
      <div class="row">
        <label for="pBranch">Pickup branch</label>
        <select id="pBranch">
          <option value="ktm">Kathmandu — Durbar Marg</option>
          <option value="pkr">Pokhara — Lakeside</option>
          <option value="ltp">Lalitpur — Jawalakhel</option>
        </select>
      </div>
      <div class="map" id="mapBox">Branch map preview</div>
      <div class="hint">Exact location will be shared after confirmation.</div>
    </div>

    <div class="section">Schedule</div>
    <div class="card">
      <div class="grid-2">
        <div class="row">
          <label for="pDate">Date</label>
          <input id="pDate" type="date">
        </div>
        <div class="row">
          <label for="pSlot">Time slot</label>
          <select id="pSlot">
            <option value="10-13">10:00–13:00</option>
            <option value="13-16">13:00–16:00</option>
            <option value="16-19">16:00–19:00</option>
          </select>
        </div>
      </div>
      <div class="row">
        <label for="pNotes">Notes (optional)</label>
        <textarea id="pNotes" placeholder="e.g., Someone else will pick up, call before arrival"></textarea>
      </div>
    </div>
  </div>
</main>

<!-- Actions -->
<div class="actions">
  <div class="wrap">
    <button class="btn btn-outline" id="btnReset">Reset</button>
    <button class="btn btn-primary btn-wide" id="btnSaveAll">Save Preferences</button>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">Saved</div>

<!-- Bottom navigation -->
<nav class="bottom-nav">
  <a class="nav-item" href="dashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
  <a class="nav-item" href="explore.html"><i class="fas fa-compass"></i><span>Explore</span></a>
  <a class="nav-item" href="add-to-cart.html"><i class="fas fa-shopping-cart"></i><span>Cart</span></a>
  <a class="nav-item" href="alerts.html"><i class="fas fa-bell"></i><span>Alerts</span></a>
  <a class="nav-item active" href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a>
</nav>

<script>
  // ------- Storage keys -------
  const KEY_FULFILL   = 'gbn_fulfillment';          // 'delivery' | 'pickup'
  const KEY_ADDRS     = 'gbn_addresses';            // array of addresses
  const KEY_ADDR_DEF  = 'gbn_default_addr';         // id
  const KEY_DELIV     = 'gbn_delivery_prefs';       // {method,instr}
  const KEY_PICKUP    = 'gbn_pickup';               // {branch,date,slot,notes}

  // ------- Helpers -------
  const $ = id => document.getElementById(id);
  const toast = $('toast');
  function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
  function getJSON(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
  function setJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  const uid = ()=>'a'+Math.random().toString(36).slice(2,10);

  // ------- DOM refs -------
  const tabDelivery=$('tabDelivery'), tabPickup=$('tabPickup');
  const deliverySection=$('deliverySection'), pickupSection=$('pickupSection');

  // Delivery
  const addrList=$('addrList'), addrEmpty=$('addrEmpty');
  const editId=$('editId'), aName=$('aName'), aPhone=$('aPhone'), aStreet=$('aStreet'), aCity=$('aCity'), aPostal=$('aPostal'), aCountry=$('aCountry'), aDefault=$('aDefault');
  const btnSaveAddr=$('btnSaveAddr'), btnClearAddr=$('btnClearAddr');
  const dMethod=$('dMethod'), dInstr=$('dInstr'), dEstimate=$('dEstimate');

  // Pickup
  const pBranch=$('pBranch'), pDate=$('pDate'), pSlot=$('pSlot'), pNotes=$('pNotes'), mapBox=$('mapBox');

  // Footer actions
  const btnReset=$('btnReset'), btnSaveAll=$('btnSaveAll');

  // ------- State -------
  let fulfillment = localStorage.getItem(KEY_FULFILL) || 'delivery';
  let addresses   = getJSON(KEY_ADDRS, []);
  let defaultAddr = localStorage.getItem(KEY_ADDR_DEF) || '';
  let delivPrefs  = getJSON(KEY_DELIV, {method:'standard', instr:''});
  let pickupPrefs = getJSON(KEY_PICKUP, {branch:'ktm', date:'', slot:'13-16', notes:''});

  // ------- UI wiring -------
  function setFulfillment(mode){
    fulfillment = mode;
    localStorage.setItem(KEY_FULFILL, mode);
    tabDelivery.classList.toggle('active', mode==='delivery');
    tabDelivery.setAttribute('aria-selected', mode==='delivery'?'true':'false');
    tabPickup.classList.toggle('active', mode==='pickup');
    tabPickup.setAttribute('aria-selected', mode==='pickup'?'true':'false');
    deliverySection.style.display = mode==='delivery' ? 'block':'none';
    pickupSection.style.display   = mode==='pickup'   ? 'block':'none';
  }
  tabDelivery.addEventListener('click', ()=>setFulfillment('delivery'));
  tabPickup.addEventListener('click',   ()=>setFulfillment('pickup'));

  // Address list render
  function renderAddresses(){
    // clear old
    addrList.querySelectorAll('.addr').forEach(n=>n.remove());
    addrEmpty.style.display = addresses.length ? 'none' : 'block';

    addresses.forEach(a=>{
      const row = document.createElement('div'); row.className='addr';
      const top = document.createElement('div'); top.className='addr-top';
      top.innerHTML = `<div class="addr-name">${a.name}</div><span class="pill-mini">${a.city || ''}</span>`;
      const sub = document.createElement('div'); sub.className='addr-sub';
      sub.textContent = `${a.street}, ${a.city}${a.postal?(' '+a.postal):''}, ${a.country} · ${a.phone}`;

      const actions = document.createElement('div'); actions.className='addr-actions';
      const left = document.createElement('div');
      const radio = document.createElement('input');
      radio.type='radio'; radio.name='defaultAddr'; radio.checked = (a.id===defaultAddr);
      radio.title='Set as default';
      radio.addEventListener('change', ()=>{
        defaultAddr = a.id; localStorage.setItem(KEY_ADDR_DEF, defaultAddr);
        showToast('Default address updated');
      });
      left.appendChild(radio);
      left.appendChild(document.createTextNode(' Default'));

      const right = document.createElement('div');
      const bEdit = document.createElement('button'); bEdit.className='btn-mini btn-edit'; bEdit.innerHTML='<i class="fa-regular fa-pen-to-square"></i>';
      const bDel  = document.createElement('button'); bDel.className='btn-mini btn-danger'; bDel.innerHTML='<i class="fa-regular fa-trash-can"></i>';
      bEdit.addEventListener('click', ()=>loadAddressToForm(a.id));
      bDel.addEventListener('click', ()=>{
        if(confirm('Delete this address?')){
          addresses = addresses.filter(x=>x.id!==a.id);
          if(defaultAddr===a.id){ defaultAddr=''; localStorage.removeItem(KEY_ADDR_DEF); }
          setJSON(KEY_ADDRS, addresses);
          renderAddresses();
          showToast('Address removed');
        }
      });
      right.appendChild(bEdit); right.appendChild(bDel);

      actions.appendChild(left); actions.appendChild(right);

      row.appendChild(top); row.appendChild(sub); row.appendChild(actions);
      addrList.appendChild(row);
    });
  }

  function clearAddressForm(){
    editId.value=''; aName.value=''; aPhone.value=''; aStreet.value='';
    aCity.value=''; aPostal.value=''; aCountry.value='Nepal'; aDefault.checked=false;
  }

  function loadAddressToForm(id){
    const a = addresses.find(x=>x.id===id); if(!a) return;
    editId.value=a.id; aName.value=a.name; aPhone.value=a.phone;
    aStreet.value=a.street; aCity.value=a.city; aPostal.value=a.postal||''; aCountry.value=a.country||'Nepal';
    aDefault.checked = (defaultAddr===a.id);
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  btnClearAddr.addEventListener('click', clearAddressForm);

  btnSaveAddr.addEventListener('click', ()=>{
    const name=aName.value.trim(), phone=aPhone.value.trim(), street=aStreet.value.trim(), city=aCity.value.trim();
    const country=aCountry.value.trim()||'Nepal', postal=aPostal.value.trim();
    if(!name||!phone||!street||!city){ alert('Please fill Name, Phone, Street and City'); return; }

    const id = editId.value || uid();
    const entry = {id,name,phone,street,city,postal,country};

    if(editId.value){
      addresses = addresses.map(x=>x.id===id?entry:x);
    }else{
      addresses.push(entry);
    }
    setJSON(KEY_ADDRS, addresses);

    if(aDefault.checked){
      defaultAddr = id; localStorage.setItem(KEY_ADDR_DEF, id);
    }
    renderAddresses();
    clearAddressForm();
    showToast('Address saved');
  });

  // Delivery prefs
  function updateEstimate(){
    const method=dMethod.value;
    const cost = method==='express' ? 450 : 250; // simple static estimate (NPR)
    const eta  = method==='express' ? '1–2 days' : '3–5 days';
    dEstimate.textContent = `NPR ${cost} • ETA ${eta}`;
  }
  dMethod.addEventListener('change', updateEstimate);

  // Pickup UI
  function setMinDate(){
    const today = new Date(); today.setHours(0,0,0,0);
    const yyyy = today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
    pDate.min = `${yyyy}-${mm}-${dd}`;
    if(!pDate.value) pDate.value = pDate.min;
  }
  function updateMap(){
    const label = pBranch.options[pBranch.selectedIndex].text;
    mapBox.textContent = label + ' — map preview';
  }
  pBranch.addEventListener('change', updateMap);

  // Reset & Save
  btnReset.addEventListener('click', ()=>{
    if(!confirm('Reset all pickup/delivery preferences?')) return;
    localStorage.removeItem(KEY_FULFILL);
    localStorage.removeItem(KEY_ADDRS);
    localStorage.removeItem(KEY_ADDR_DEF);
    localStorage.removeItem(KEY_DELIV);
    localStorage.removeItem(KEY_PICKUP);
    // Reset state
    fulfillment='delivery'; addresses=[]; defaultAddr=''; delivPrefs={method:'standard',instr:''};
    pickupPrefs={branch:'ktm',date:'',slot:'13-16',notes:''};
    // Paint
    setFulfillment('delivery');
    renderAddresses();
    clearAddressForm();
    dMethod.value='standard'; dInstr.value=''; updateEstimate();
    pBranch.value='ktm'; setMinDate(); pSlot.value='13-16'; pNotes.value=''; updateMap();
    showToast('Reset complete');
  });

  btnSaveAll.addEventListener('click', ()=>{
    // Save delivery prefs
    delivPrefs = {method:dMethod.value, instr:dInstr.value.trim()};
    setJSON(KEY_DELIV, delivPrefs);
    // Save pickup prefs
    pickupPrefs = {branch:pBranch.value, date:pDate.value, slot:pSlot.value, notes:pNotes.value.trim()};
    setJSON(KEY_PICKUP, pickupPrefs);
    // Save fulfillment already handled by setFulfillment
    showToast('Preferences saved');
  });

  // ------- Initial paint -------
  setFulfillment(fulfillment);
  renderAddresses();
  // Load delivery prefs
  dMethod.value = delivPrefs.method || 'standard';
  dInstr.value  = delivPrefs.instr || '';
  updateEstimate();
  // Load pickup prefs
  pBranch.value = pickupPrefs.branch || 'ktm';
  setMinDate();
  if(pickupPrefs.date) pDate.value = pickupPrefs.date;
  pSlot.value = pickupPrefs.slot || '13-16';
  pNotes.value = pickupPrefs.notes || '';
  updateMap();
</script>
</body>

<!-- Bottom nav -->
<nav class="bottom-nav">
  <a class="nav-item" href="dashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
  <a class="nav-item" href="explore.html"><i class="fas fa-compass"></i><span>Explore</span></a>
  <a class="nav-item" href="add-to-cart.html"><i class="fas fa-shopping-cart"></i><span>Cart</span></a>
  <a class="nav-item" href="alerts.html"><i class="fas fa-bell"></i><span>Alerts</span></a>
  <a class="nav-item active" href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a>
</nav>
</html>
