<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Change Password • GoBuy Nepal</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>

  <style>
    :root{
      --purple:#7a1ea1; --purple-700:#5b1680; --bg:#fff; --card:#fff; --line:#e9e9ef;
      --muted:#7b7f88; --danger:#e74c3c; --green:#2ecc71; --orange:#d35400;
      --radius:14px; --shadow:0 10px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:#1e1e1e;padding-bottom:96px}
    .page{max-width:450px;margin:0 auto;padding-bottom:140px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:3;background:#fff;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;padding:12px 14px 10px}
    .top-btn{color:var(--purple);font-size:18px;text-decoration:none}
    .title{font-weight:900;color:#444}
    .right{width:28px}

    /* Cards / form */
    .section{margin:16px 12px 10px;font-size:12px;text-transform:uppercase;color:var(--muted);letter-spacing:.4px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);margin:0 12px 14px;padding:12px}
    .row{display:grid;gap:6px;margin-bottom:10px}
    label{font-weight:700;font-size:13px;color:#333}
    .inwrap{position:relative}
    input[type="email"],input[type="password"],input[type="text"]{
      width:100%;padding:11px 40px 11px 12px;border:1px solid #dcdde3;border-radius:10px;outline:none;font-size:15px;background:#fff
    }
    .toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:none;background:transparent;color:#777;cursor:pointer}
    .hint{font-size:12px;color:#777}

    /* Strength meter */
    .meter{height:8px;background:#f1f1f5;border-radius:999px;overflow:hidden;border:1px solid #ececf3}
    .bar{height:100%;width:0;background:#dcdde3;transition:width .25s, background .25s;border-radius:999px}
    .reqs{display:grid;gap:4px;margin-top:6px}
    .req{font-size:12px;color:#666;display:flex;align-items:center;gap:6px}
    .req i{color:#bbb}
    .req.ok i{color:var(--green)}
    .req.bad i{color:var(--danger)}

    /* Actions */
    .actions{position:fixed;left:0;right:0;bottom:70px;display:flex;justify-content:center;pointer-events:none;z-index:50}
    .actions .wrap{width:100%;max-width:450px;padding:0 12px;display:flex;gap:10px;pointer-events:auto}
    .btn{border:none;border-radius:12px;padding:13px 14px;font-weight:900;cursor:pointer}
    .btn-primary{background:var(--purple);color:#fff;flex:1}
    .btn-outline{background:#fff;color:var(--purple);border:2px solid var(--purple)}
    .btn-ghost{background:#fff;color:#444;border:2px solid #ddd}

    .error{color:var(--danger);font-size:13px;margin-top:4px;display:none}
    .ok{color:var(--green);font-size:13px;margin-top:4px;display:none}

    /* Bottom nav */
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);
      display:flex;justify-content:space-around;align-items:center;padding:8px 0;z-index:999;box-shadow:0 -2px 8px rgba(0,0,0,.05)}
    .nav-item{color:var(--purple);text-decoration:none;font-size:12px;display:flex;flex-direction:column;align-items:center}
    .nav-item i{font-size:20px;margin-bottom:4px}
    .nav-item.active span{font-weight:800}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:120px;transform:translateX(-50%);background:#222;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;opacity:0;transition:.25s;z-index:9999}
    .toast.show{opacity:1}
  </style>
</head>
<body>

<main class="page">
  <!-- Top bar -->
  <div class="topbar">
    <a class="top-btn" href="profile.html" aria-label="Back to Profile"><i class="fa-solid fa-chevron-left"></i></a>
    <div class="title">Change Password</div>
    <div class="right"></div>
  </div>

  <!-- Account -->
  <div class="section">Account</div>
  <section class="card">
    <div class="row">
      <label for="email">Signed in as</label>
      <input id="email" type="email" readonly>
      <div id="providerNote" class="hint" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- Change password form -->
  <div class="section">Update password</div>
  <section class="card" id="formCard">
    <div class="row">
      <label for="currentPw">Current password</label>
      <div class="inwrap">
        <input id="currentPw" type="password" autocomplete="current-password" placeholder="Enter current password">
        <button class="toggle" type="button" data-target="currentPw"><i class="fa-regular fa-eye"></i></button>
      </div>
    </div>

    <div class="row">
      <label for="newPw">New password</label>
      <div class="inwrap">
        <input id="newPw" type="password" autocomplete="new-password" placeholder="At least 8 characters">
        <button class="toggle" type="button" data-target="newPw"><i class="fa-regular fa-eye"></i></button>
      </div>
      <div class="meter" aria-hidden="true"><div id="bar" class="bar"></div></div>
      <div class="reqs">
        <div id="r_len"   class="req"><i class="fa-solid fa-circle"></i> Minimum 8 characters</div>
        <div id="r_mix"   class="req"><i class="fa-solid fa-circle"></i> Mix of letters & numbers</div>
        <div id="r_case"  class="req"><i class="fa-solid fa-circle"></i> Upper & lower case</div>
        <div id="r_spec"  class="req"><i class="fa-solid fa-circle"></i> A symbol (!@#$…)</div>
      </div>
    </div>

    <div class="row">
      <label for="confirmPw">Confirm new password</label>
      <div class="inwrap">
        <input id="confirmPw" type="password" autocomplete="new-password" placeholder="Re-enter new password">
        <button class="toggle" type="button" data-target="confirmPw"><i class="fa-regular fa-eye"></i></button>
      </div>
    </div>

    <div id="err" class="error"></div>
    <div id="ok" class="ok">Password updated!</div>

    <div class="row" style="margin-top:6px">
      <button class="btn btn-ghost" id="sendReset" type="button"><i class="fa-regular fa-envelope"></i> Send reset email instead</button>
    </div>
  </section>
</main>

<!-- Actions -->
<div class="actions">
  <div class="wrap">
    <button class="btn btn-outline" type="button" onclick="location.href='profile.html'">Cancel</button>
    <button class="btn btn-primary" id="updateBtn" type="button">Update Password</button>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">Saved</div>

<!-- Bottom navigation -->
<nav class="bottom-nav">
  <a class="nav-item" href="dashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
  <a class="nav-item" href="explore.html"><i class="fas fa-compass"></i><span>Explore</span></a>
  <a class="nav-item" href="add-to-cart.html"><i class="fas fa-shopping-cart"></i><span>Cart</span></a>
  <a class="nav-item" href="alerts.html"><i class="fas fa-bell"></i><span>Alerts</span></a>
  <a class="nav-item active" href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a>
</nav>

<script>
  // --- Firebase init ---
  const firebaseConfig = {
    apiKey: "AIzaSyAMkXABYjKGsjXbYngMNEH8lZHQwnV7sco",
    authDomain: "gobuy-nepal-chat.firebaseapp.com",
    projectId: "gobuy-nepal-chat",
    storageBucket: "gobuy-nepal-chat.firebasestorage.app",
    messagingSenderId: "139074488540",
    appId: "1:139074488540:web:ec916e07013f67a8568c19",
    measurementId: "G-9F98X85V19"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // --- Helpers ---
  const $ = id => document.getElementById(id);
  const toast = $('toast');
  function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1300); }

  function setError(msg){ const e=$('err'); e.textContent=msg; e.style.display='block'; $('ok').style.display='none'; }
  function setOk(msg){ const o=$('ok'); o.textContent=msg || 'Password updated!'; o.style.display='block'; $('err').style.display='none'; }

  // --- Auth gate & provider note ---
  let currentUser = null;
  auth.onAuthStateChanged(user=>{
    if(!user){ location.href = 'index.html'; return; }
    currentUser = user;
    $('email').value = user.email || '(no email)';
    const hasPasswordProvider = (user.providerData || []).some(p=>p.providerId === 'password');
    const note = hasPasswordProvider
      ? 'You signed in with email & password.'
      : 'Your account uses a social provider (e.g., Google). You may need to use "Reset by email" or your provider to change password.';
    $('providerNote').textContent = note;
    // Disable currentPw if no password provider
    $('currentPw').disabled = !hasPasswordProvider;
  });

  // --- Show/Hide toggles ---
  document.querySelectorAll('.toggle').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = document.getElementById(btn.getAttribute('data-target'));
      if(!target) return;
      const isPw = target.type === 'password';
      target.type = isPw ? 'text' : 'password';
      btn.innerHTML = `<i class="fa-regular fa-eye${isPw?'-slash':''}"></i>`;
    });
  });

  // --- Strength meter ---
  const newPw = $('newPw');
  function scorePassword(pw){
    let score = 0;
    const hasLen  = pw.length >= 8;
    const hasNum  = /\d/.test(pw);
    const hasLow  = /[a-z]/.test(pw);
    const hasUp   = /[A-Z]/.test(pw);
    const hasSpec = /[^A-Za-z0-9]/.test(pw);
    const checks = {hasLen, hasNum, hasLow, hasUp, hasSpec};

    // UI ticks
    $('r_len').className  = 'req ' + (hasLen ? 'ok':'bad');
    $('r_mix').className  = 'req ' + ((hasLow && hasNum) ? 'ok':'bad');
    $('r_case').className = 'req ' + ((hasLow && hasUp) ? 'ok':'bad');
    $('r_spec').className = 'req ' + (hasSpec ? 'ok':'bad');

    // basic scoring
    if (hasLen) score += 25;
    if (hasLow && hasUp) score += 25;
    if (hasNum) score += 20;
    if (hasSpec) score += 30;
    score = Math.min(100, score);

    const bar = $('bar');
    bar.style.width = score + '%';
    bar.style.background = score < 40 ? '#ff7675' : (score < 70 ? '#f39c12' : '#2ecc71');

    return {score, checks};
  }
  newPw.addEventListener('input', ()=> scorePassword(newPw.value));

  // --- Update password flow ---
  $('updateBtn').addEventListener('click', async ()=>{
    const cur = $('currentPw').value;
    const npw = $('newPw').value;
    const cfm = $('confirmPw').value;

    if(!currentUser){ setError('Not signed in.'); return; }
    if(!npw || !cfm){ setError('Fill all fields.'); return; }
    if(npw !== cfm){ setError('New passwords do not match.'); return; }

    const {score, checks} = scorePassword(npw);
    if(!(checks.hasLen && (checks.hasLow && checks.hasUp) && checks.hasNum)){
      setError('Please meet the password requirements.'); return;
    }

    try{
      // Re-authenticate only when email/password provider is available
      const usesPassword = (currentUser.providerData||[]).some(p=>p.providerId==='password');
      if(usesPassword){
        if(!cur){ setError('Enter your current password.'); return; }
        const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, cur);
        await currentUser.reauthenticateWithCredential(cred);
      }
      await currentUser.updatePassword(npw);
      setOk('Password updated ✔️');
      showToast('Password changed');
      // Optional: clear fields
      $('currentPw').value = ''; $('newPw').value = ''; $('confirmPw').value = '';
      $('bar').style.width = '0%';
      // Navigate back after a moment
      setTimeout(()=> location.href='profile.html', 800);
    }catch(err){
      // Friendly messages
      const code = err && err.code ? String(err.code) : '';
      let msg = err.message || 'Failed to update password.';
      if(code==='auth/wrong-password') msg = 'Current password is incorrect.';
      else if(code==='auth/weak-password') msg = 'New password is too weak.';
      else if(code==='auth/requires-recent-login') msg = 'Please sign in again and retry.';
      else if(code==='auth/too-many-requests') msg = 'Too many attempts. Try again later.';
      else if(code==='auth/network-request-failed') msg = 'Network error. Check your connection.';
      setError(msg);
    }
  });

  // --- Reset by email ---
  $('sendReset').addEventListener('click', async ()=>{
    if(!currentUser || !currentUser.email){ setError('No email on this account.'); return; }
    if(!confirm('Send a password reset email to ' + currentUser.email + '?')) return;
    try{
      await auth.sendPasswordResetEmail(currentUser.email);
      showToast('Reset email sent');
    }catch(err){
      const code = err.code || '';
      let msg = err.message || 'Could not send reset email.';
      if(code==='auth/invalid-email') msg = 'Invalid email.';
      if(code==='auth/user-not-found') msg = 'No user found for this email.';
      setError(msg);
    }
  });
</script>
</body>

<!-- Bottom nav -->
<nav class="bottom-nav">
  <a class="nav-item" href="dashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
  <a class="nav-item" href="explore.html"><i class="fas fa-compass"></i><span>Explore</span></a>
  <a class="nav-item" href="add-to-cart.html"><i class="fas fa-shopping-cart"></i><span>Cart</span></a>
  <a class="nav-item" href="alerts.html"><i class="fas fa-bell"></i><span>Alerts</span></a>
  <a class="nav-item active" href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a>
</nav>
</html>
